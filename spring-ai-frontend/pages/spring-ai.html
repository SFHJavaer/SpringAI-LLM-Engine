<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½åŠ©æ‰‹ - æ™ºèƒ½å¯¹è¯å¹³å°</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- ç°ä»£åŒ–çš„CSSè®¾è®¡ -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #06b6d4;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .navbar-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .navbar-brand i {
            font-size: 1.75rem;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow);
        }

        .user-menu {
            position: relative;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition);
            z-index: 1000;
        }

        .user-menu.open .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .dropdown-item:hover {
            background: var(--surface-light);
            color: var(--primary-color);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item i {
            margin-right: 0.5rem;
            width: 16px;
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
            padding-top: 0;
            position: relative;
        }



        /* èŠå¤©åŒºåŸŸ */
        .chat-container {
            flex: 1;
            margin-left: 0;
            display: flex;
            flex-direction: column;
            background: var(--background);
            height: 100%;
            overflow: hidden;
        }

        /* èŠå¤©å¤´éƒ¨ */
        .chat-header {
            background: var(--surface);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .chat-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .chat-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .chat-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .controls-panel {
            background: var(--surface);
            border-top: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            margin: 0 2rem;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .panel-header {
            margin-bottom: 0;
        }

        .panel-toggle {
            width: 100%;
            background: transparent;
            border: none;
            padding: 0.75rem 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            transition: var(--transition);
            border-radius: 6px;
        }

        .panel-toggle:hover {
            background: var(--surface-light);
            color: var(--primary-color);
        }

        .panel-toggle i {
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }

        .panel-toggle.collapsed i {
            transform: rotate(-180deg);
        }

        .toggle-text {
            font-weight: 500;
        }

                    .panel-controls {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                padding: 1rem 0;
                border-top: 1px solid var(--border-color);
                margin-top: 0.5rem;
                transition: all 0.3s ease;
                max-height: 200px;
                overflow: hidden;
            }

            .panel-controls.collapsed {
                max-height: 0;
                padding: 0;
                margin-top: 0;
                opacity: 0;
                border-top: none;
            }

            .panel-toggle {
                font-size: 0.85rem;
                padding: 0.5rem 0;
            }

            .panel-toggle i {
                font-size: 0.7rem;
            }

        .control-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .control-label {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 100px;
        }

        .search-controls {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ ·å¼ */
        .custom-dropdown {
            position: relative;
            min-width: 200px;
        }

        .dropdown-trigger {
            background: var(--surface-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 20px;
        }

        .dropdown-trigger:hover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.05);
        }

        .dropdown-trigger.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .selected-text {
            color: var(--text-primary);
            font-weight: 500;
            flex: 1;
        }

        .dropdown-arrow {
            color: var(--text-secondary);
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }

        .dropdown-arrow.rotated {
            transform: rotate(180deg);
        }

        .dropdown-options {
            position: fixed;
            top: auto;
            left: auto;
            right: auto;
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            pointer-events: none;
        }

        .dropdown-options.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto;
        }

        .dropdown-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .dropdown-option:last-child {
            border-bottom: none;
        }

        .dropdown-option:hover {
            background: rgba(99, 102, 241, 0.08);
            color: var(--primary-color);
        }

        .dropdown-option.selected {
            background: var(--primary-color);
            color: white;
        }

        .dropdown-option i {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        .dropdown-option span {
            flex: 1;
            font-weight: 500;
        }

        .chat-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
            min-width: fit-content;
        }

        .control-group {
            display: flex;
            gap: 0.5rem;
        }

        .toggle-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
            min-width: 120px;
            justify-content: center;
        }

        .toggle-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
        }

        .toggle-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        /* ç¡®ä¿æ§åˆ¶æŒ‰é’®åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šéƒ½å¯è§ */
        .chat-controls {
            flex-shrink: 0;
            min-width: fit-content;
        }

        .control-group {
            flex-shrink: 0;
        }

        /* æ¶ˆæ¯åŒºåŸŸ */
        .messages-container {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: var(--background);
            height: 100%;
            max-height: calc(100vh - 70px - 200px); /* å‡å»å¯¼èˆªæ å’Œè¾“å…¥åŒºåŸŸé«˜åº¦ */
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 2rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            animation: messageSlide 0.4s ease-out;
            will-change: transform;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            order: 2;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }

        .message-content {
            max-width: 70%;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            position: relative;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 0.95rem;
            will-change: auto;
            transform: translateZ(0); /* å¼ºåˆ¶GPUåŠ é€Ÿ */
            backface-visibility: hidden; /* é˜²æ­¢é—ªçƒ */
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-bottom-right-radius: 8px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .message.bot .message-content {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            text-align: center;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: var(--surface);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            width: fit-content;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-color);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-container {
            background: var(--surface);
            border-top: 1px solid var(--border-color);
            padding: 2rem;
        }

        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .input-form {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            margin-bottom: 1rem;
        }

        .message-input {
            flex: 1;
            padding: 1rem 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background: var(--background);
            color: var(--text-primary);
            resize: none;
            outline: none;
            transition: var(--transition);
            min-height: 56px;
            max-height: 200px;
        }

        .message-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .message-input::placeholder {
            color: var(--text-secondary);
        }

        .send-btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition);
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            background: var(--background);
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        .upload-text {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .upload-text i {
            margin-right: 0.5rem;
            color: var(--primary-color);
        }

        .upload-hint {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: var(--background);
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--surface-light);
            border-radius: 4px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: var(--border-color);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .navbar-container {
                padding: 0 1rem;
            }

            .chat-header {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .chat-info {
                width: 100%;
            }

            .controls-panel {
                padding: 1rem;
                margin: 0 1rem;
                border-radius: 8px 8px 0 0;
            }

            .control-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                width: 100%;
            }

            .control-label {
                min-width: auto;
                font-size: 0.875rem;
            }

            .search-controls {
                width: 100%;
                justify-content: flex-start;
                gap: 0.5rem;
            }

            .toggle-btn {
                min-width: 120px;
                font-size: 0.8rem;
            }

            .chat-controls {
                width: 100%;
                justify-content: flex-start;
                gap: 1rem;
                flex-wrap: wrap;
            }

            .control-group {
                display: flex;
                gap: 1rem;
                flex-wrap: wrap;
                flex-shrink: 0;
            }

            .custom-dropdown {
                min-width: 180px;
            }

            .dropdown-trigger {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .dropdown-option {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .messages-container {
                padding: 1rem;
            }

            .input-container {
                padding: 1rem;
            }

            .message-content {
                max-width: 85%;
            }
        }

        @media (max-width: 768px) {
            .navbar-container {
                padding: 0 1rem;
            }

            .chat-header {
                padding: 1rem;
            }

            .messages-container {
                padding: 1rem;
            }

            .input-container {
                padding: 1rem;
            }

            .message-content {
                max-width: 85%;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* åŠ è½½åŠ¨ç”»æ ·å¼ */
        .loading-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            min-height: 40px;
        }

        .loading-dots {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem 0;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-color);
            animation: loading-bounce 1.4s ease-in-out infinite both;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes loading-bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-left: 0.5rem;
            animation: loading-pulse 2s ease-in-out infinite;
        }

        @keyframes loading-pulse {
            0%, 100% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
        }

        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }


    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="#" class="navbar-brand">
                <i class="fas fa-robot"></i>
                AIæ™ºèƒ½åŠ©æ‰‹
            </a>
            <div class="navbar-user">
                <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">U</div>
                <div class="user-menu" id="userMenu">
                    <div class="user-dropdown">
                        <a href="#" class="dropdown-item" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            é€€å‡ºç™»å½•
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-container" id="mainContainer">
        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <main class="chat-container" id="doctorPage">
            <!-- èŠå¤©å¤´éƒ¨ -->
            <header class="chat-header">
                <div class="chat-info">
                    <h1 class="chat-title">
                        <i class="fas fa-comments"></i>
                        æ™ºèƒ½å¯¹è¯
                    </h1>
                    <p class="chat-subtitle">ä¸AIåŠ©æ‰‹è¿›è¡Œæ™ºèƒ½å¯¹è¯</p>
                </div>
            </header>

            <!-- æ¶ˆæ¯åŒºåŸŸ -->
            <div class="messages-container" id="chatMessages">
                <div class="message bot">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIæ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ
                        <div class="message-time" id="welcomeTime"></div>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="controls-panel" id="controlsPanel">
                <div class="panel-header">
                    <button class="panel-toggle" id="panelToggle" onclick="toggleControlPanel()">
                        <i class="fas fa-chevron-down"></i>
                        <span class="toggle-text">å¯¹è¯è®¾ç½®</span>
                    </button>
                </div>
                <div class="panel-controls" id="panelControls">
                    <div class="control-row">
                        <label for="modelSelect" class="control-label">
                            <i class="fas fa-robot"></i>
                            æ¨¡å‹é€‰æ‹©ï¼š
                        </label>
                        <div class="custom-dropdown" id="modelDropdown">
                            <div class="dropdown-trigger" onclick="toggleDropdown()">
                                <span class="selected-text" id="selectedModel">Deepseek</span>
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </div>
                            <div class="dropdown-options" id="dropdownOptions">
                                <div class="dropdown-option" data-value="deepseekClient" onclick="selectOption('deepseekClient', 'Deepseek')">
                                    <i class="fas fa-robot"></i>
                                    <span>Deepseek</span>
                                </div>
                                <div class="dropdown-option" data-value="gptminiClient" onclick="selectOption('gptminiClient', 'ChatGPT-4.1-mini')">
                                    <i class="fab fa-openai"></i>
                                    <span>ChatGPT-4.1-mini</span>
                                </div>
                            </div>
                            <select class="model-selector" id="modelSelect" style="display: none;">
                                <option value="deepseekClient">Deepseek</option>
                                <option value="gptminiClient">ChatGPT-4.1-mini</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-row">
                        <label class="control-label">
                            <i class="fas fa-search"></i>
                            æœç´¢æ¨¡å¼ï¼š
                        </label>
                        <div class="search-controls">
                            <button class="toggle-btn" id="internetSearchBtn" onclick="toggleSearch('internet')" title="è”ç½‘æœç´¢ï¼ˆä¸çŸ¥è¯†åº“äº’æ–¥ï¼‰">
                                <i class="fas fa-globe"></i>
                                ğŸŒ è”ç½‘æœç´¢
                            </button>
                            <button class="toggle-btn" id="knowledgeSearchBtn" onclick="toggleSearch('knowledge')" title="çŸ¥è¯†åº“æœç´¢ï¼ˆä¸è”ç½‘æœç´¢äº’æ–¥ï¼‰">
                                <i class="fas fa-book"></i>
                                ğŸ“š çŸ¥è¯†åº“
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-container">
                <div class="input-wrapper">
                    <form class="input-form" onsubmit="sendMessage(event)">
                        <textarea
                            class="message-input"
                            id="messageInput"
                            placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"></textarea>
                        <button class="send-btn" id="sendBtn" type="submit">
                            <i class="fas fa-paper-plane"></i>
                            å‘é€
                        </button>
                    </form>

                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()" title="ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶åˆ°çŸ¥è¯†åº“">
                        <div class="upload-text">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <br>
                            ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡æ¡£åˆ°çŸ¥è¯†åº“
                        </div>
                        <div class="upload-hint">æ”¯æŒæ ¼å¼ï¼šTXTã€PDFã€DOCã€DOCXï¼ˆæœ€å¤§10MBï¼‰</div>
                        <input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx" style="display: none;" onchange="handleFileUpload(event)">
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <!-- ä¾èµ–åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- æœ¬åœ°ä¾èµ– -->
    <script src="../js/request.js"></script>
    <script src="../js/apis/admin/doctorApi.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;
        let chatList = [];
        let botMsgId = null;
        let source = null;
        let isTyping = false;
        let currentPage = 'chat';
        let isSending = false; // é˜²æ­¢é‡å¤å‘é€

        // æœç´¢æ¨¡å¼
        let searchModes = {
            internet: false,
            knowledge: false
        };

        // æ§åˆ¶é¢æ¿çŠ¶æ€
        let isPanelCollapsed = true;

        // APIé…ç½®
        const API_BASE_URL = 'http://127.0.0.1:8888';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            initUserInfo();
            initSSE();
            setWelcomeTime();
            setupDragAndDrop();
            setupMenus();

            // åˆå§‹åŒ–æ§åˆ¶é¢æ¿çŠ¶æ€
            initControlPanel();

            // è°ƒè¯•ï¼šç¡®è®¤æŒ‰é’®æ˜¯å¦å­˜åœ¨
            setTimeout(() => {
                const internetBtn = document.getElementById('internetSearchBtn');
                const knowledgeBtn = document.getElementById('knowledgeSearchBtn');
                const modelSelect = document.getElementById('modelSelect');

                console.log('ğŸ” è°ƒè¯•ä¿¡æ¯:');
                console.log('è”ç½‘æœç´¢æŒ‰é’®:', internetBtn ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                console.log('çŸ¥è¯†åº“æŒ‰é’®:', knowledgeBtn ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                console.log('æ¨¡å‹é€‰æ‹©å™¨:', modelSelect ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');

                if (internetBtn) console.log('è”ç½‘æœç´¢æŒ‰é’®æ–‡æœ¬:', internetBtn.textContent);
                if (knowledgeBtn) console.log('çŸ¥è¯†åº“æŒ‰é’®æ–‡æœ¬:', knowledgeBtn.textContent);
            }, 1000);
        });

        // æ£€æŸ¥ç”¨æˆ·è®¤è¯
        function checkAuth() {
            const token = Cookies.get('userToken');
            const userInfo = Cookies.get('userInfo');

            if (!token || !userInfo) {
                window.location.href = 'login.html';
                return;
            }

            try {
                currentUser = JSON.parse(userInfo);
            } catch (error) {
                console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                logout();
            }
        }

        // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
        function initUserInfo() {
            if (currentUser) {
                document.getElementById('userAvatar').textContent = (currentUser.username || 'U').charAt(0).toUpperCase();
            }
        }

        // è®¾ç½®æ¬¢è¿æ¶ˆæ¯æ—¶é—´
        function setWelcomeTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('welcomeTime').textContent = timeString;
        }

        // åˆå§‹åŒ–SSEè¿æ¥
        function initSSE() {
            if (!currentUser) return;

            if (window.EventSource) {
                // ä½¿ç”¨ç”¨æˆ·idè€Œä¸æ˜¯ç”¨æˆ·å
                const userId = currentUser.id || currentUser.username;
                source = new EventSource(`${API_BASE_URL}/sse/connect?userId=${userId}`);

                source.addEventListener('open', function(e) {
                    console.log('SSEè¿æ¥å·²å»ºç«‹');
                });

                source.addEventListener('add', function(e) {
                    handleStreamMessage(e.data);
                });

                source.addEventListener('finish', function(e) {
                    handleStreamFinish(e.data);
                });

                source.addEventListener('error', function(e) {
                    console.error('SSEè¿æ¥é”™è¯¯:', e);
                    if (source.readyState === EventSource.CLOSED) {
                        console.log('SSEè¿æ¥å·²å…³é—­');
                    }
                });
            } else {
                console.log('æµè§ˆå™¨ä¸æ”¯æŒSSE');
            }
        }

        // å¤„ç†æµå¼æ¶ˆæ¯
        function handleStreamMessage(data) {
            console.log('æ”¶åˆ°æµå¼æ¶ˆæ¯:', data, 'é•¿åº¦:', data.length, 'isTyping:', isTyping, 'botMsgId:', botMsgId);

            if (!isTyping) {
                // ç¬¬ä¸€æ¬¡æ”¶åˆ°æµå¼æ¶ˆæ¯ï¼ŒæŸ¥æ‰¾ç°æœ‰çš„åŠ è½½æ¶ˆæ¯å¹¶æ›¿æ¢
                isTyping = true;
                console.log('å¼€å§‹æ–°çš„æµå¼è¾“å‡ºï¼Œæ›¿æ¢åŠ è½½çŠ¶æ€');

                // æŸ¥æ‰¾ç°æœ‰çš„åŠ è½½æ¶ˆæ¯
                const loadingMessage = chatList.find(msg => msg.chatType === 'bot' && msg.botMsgId === botMsgId && msg.isLoading);
                if (loadingMessage) {
                    // æ›¿æ¢åŠ è½½çŠ¶æ€ä¸ºå®é™…å†…å®¹
                    loadingMessage.content = data;
                    loadingMessage.isLoading = false;
                    console.log('æˆåŠŸæ›¿æ¢åŠ è½½çŠ¶æ€ä¸º:', data);
                    updateMessageDisplay();
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°åŠ è½½æ¶ˆæ¯ï¼Œåˆ›å»ºæ–°æ¶ˆæ¯ï¼ˆå¤‡ç”¨é€»è¾‘ï¼‰
                    console.log('æœªæ‰¾åˆ°åŠ è½½æ¶ˆæ¯ï¼Œåˆ›å»ºæ–°æ¶ˆæ¯');
                    const botMessage = {
                        id: Date.now(),
                        content: data,
                        chatType: 'bot',
                        botMsgId: botMsgId,
                        time: new Date(),
                        isComplete: false,
                        isLoading: false
                    };
                    chatList.push(botMessage);
                    updateMessageDisplay();
                }
            } else {
                // åç»­çš„æµå¼æ¶ˆæ¯ï¼Œæ›´æ–°ç°æœ‰æ¶ˆæ¯
                const lastMessage = chatList[chatList.length - 1];
                if (lastMessage && lastMessage.chatType === 'bot' && lastMessage.botMsgId === botMsgId) {
                    // ç¡®ä¿ä¸æ˜¯åŠ è½½çŠ¶æ€
                    if (lastMessage.isLoading) {
                        lastMessage.isLoading = false;
                    }
                    lastMessage.content += data;
                    console.log('æ›´æ–°æ¶ˆæ¯å†…å®¹ä¸º:', lastMessage.content);
                    updateLastMessageContent(lastMessage.content);
                } else {
                    console.error('æµå¼æ¶ˆæ¯å¤„ç†å¤±è´¥ - æ¶ˆæ¯ä¸åŒ¹é…', {
                        lastMessage: lastMessage,
                        expectedBotMsgId: botMsgId,
                        chatList: chatList
                    });
                }
            }
        }

        // å¤„ç†æµå¼æ¶ˆæ¯ç»“æŸ
        function handleStreamFinish(data) {
            try {
                const response = JSON.parse(data);
                const message = response.message;
                const botMsgId = response.botMsgId;

                const lastMessage = chatList[chatList.length - 1];
                if (lastMessage && lastMessage.chatType === 'bot' && lastMessage.botMsgId === botMsgId) {
                    lastMessage.content = marked.parse(message);
                    lastMessage.isComplete = true;
                    console.log('æµå¼è¾“å‡ºå®Œæˆï¼Œæœ€ç»ˆå†…å®¹:', lastMessage.content);
                    updateLastMessageContent(lastMessage.content);
                } else {
                    console.error('æµå¼å®Œæˆæ—¶æœªæ‰¾åˆ°åŒ¹é…çš„æ¶ˆæ¯', {
                        lastMessage: lastMessage,
                        expectedBotMsgId: botMsgId,
                        finishBotMsgId: botMsgId,
                        chatList: chatList
                    });
                }
                isTyping = false;

                // æµå¼è¾“å‡ºå®Œæˆæ—¶æ»šåŠ¨åˆ°åº•éƒ¨
                scrollToBottom();
            } catch (error) {
                console.error('è§£æå®Œæˆæ¶ˆæ¯å¤±è´¥:', error);
                isTyping = false;
            }
        }

        // åªæ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯çš„å†…å®¹ï¼ˆç”¨äºæµå¼è¾“å‡ºï¼‰
        function updateLastMessageContent(content) {
            const chatMessages = document.getElementById('chatMessages');

            // æŸ¥æ‰¾å½“å‰æ­£åœ¨æµå¼è¾“å‡ºçš„æ¶ˆæ¯ï¼ˆé€šè¿‡botMsgIdåŒ¹é…ï¼‰
            const currentStreamingMessage = chatMessages.querySelector(`[data-botmsgid="${botMsgId}"]`);

            if (currentStreamingMessage) {
                const contentDiv = currentStreamingMessage.querySelector('.message-content');
                if (contentDiv) {
                    contentDiv.innerHTML = content;
                }
                // æµå¼æ›´æ–°æ—¶ä¹Ÿæ»šåŠ¨åˆ°åº•éƒ¨
                scrollToBottom();
            } else {
                console.error('æœªæ‰¾åˆ°å½“å‰æµå¼è¾“å‡ºçš„æ¶ˆæ¯å…ƒç´ ', {
                    botMsgId: botMsgId,
                    chatMessagesHTML: chatMessages.innerHTML
                });
            }
        }

        // æ›´æ–°æ¶ˆæ¯æ˜¾ç¤ºï¼ˆç”¨äºæ·»åŠ æ–°æ¶ˆæ¯ï¼‰
        function updateMessageDisplay() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            chatList.forEach((msg, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.chatType}`;
                messageDiv.setAttribute('data-botmsgid', msg.botMsgId || ''); // æ·»åŠ æ ‡è¯†ç¬¦

                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'message-avatar';
                avatarDiv.textContent = msg.chatType === 'user' ? (currentUser.username || 'U').charAt(0).toUpperCase() : 'AI';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';

                // å¦‚æœæ˜¯åŠ è½½çŠ¶æ€çš„æ¶ˆæ¯ï¼Œæ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                if (msg.isLoading) {
                    contentDiv.innerHTML = `
                        <div class="loading-container">
                            <div class="loading-dots">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                            <span class="loading-text">AIæ­£åœ¨æ€è€ƒä¸­...</span>
                        </div>
                    `;
                } else {
                    contentDiv.innerHTML = msg.content;
                }

                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = formatTime(msg.time);

                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(timeDiv);

                chatMessages.appendChild(messageDiv);
            });
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage(event) {
            event.preventDefault();
            console.log('=== å¼€å§‹å‘é€æ¶ˆæ¯ ===');

            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = messageInput.value.trim();

            if (!message || !currentUser) {
                console.log('æ¶ˆæ¯ä¸ºç©ºæˆ–ç”¨æˆ·æœªç™»å½•ï¼Œå–æ¶ˆå‘é€');
                return;
            }

            // é˜²æ­¢é‡å¤å‘é€
            if (isSending) {
                console.log('æ­£åœ¨å‘é€æ¶ˆæ¯ä¸­ï¼Œå¿½ç•¥é‡å¤è¯·æ±‚');
                return;
            }

            isSending = true;
            console.log('ç”¨æˆ·æ¶ˆæ¯:', message);
            console.log('å½“å‰ç”¨æˆ·:', currentUser);
            console.log('å½“å‰æœç´¢æ¨¡å¼:', searchModes);

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©åˆ—è¡¨
            const userMessage = {
                id: Date.now(),
                content: message,
                chatType: 'user',
                time: new Date()
            };
            chatList.push(userMessage);

            // ç”Ÿæˆå”¯ä¸€çš„botæ¶ˆæ¯ID
            botMsgId = 'bot_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            console.log('ç”Ÿæˆçš„botMsgId:', botMsgId);

            // ç«‹å³åˆ›å»ºå¸¦æœ‰åŠ è½½åŠ¨ç”»çš„botæ¶ˆæ¯å ä½ç¬¦
            const loadingMessage = {
                id: Date.now() + 1,
                content: '', // å†…å®¹å¿…é¡»ä¸ºç©ºï¼Œç¡®ä¿updateMessageDisplayèƒ½æ­£ç¡®æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                chatType: 'bot',
                botMsgId: botMsgId,
                time: new Date(),
                isComplete: false,
                isLoading: true  // è¿™ä¸ªæ ‡å¿—å‘Šè¯‰updateMessageDisplayæ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            };
            chatList.push(loadingMessage);

            // æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆåŒ…æ‹¬åŠ è½½åŠ¨ç”»ï¼‰
            updateMessageDisplay();

            // ç”¨æˆ·å‘é€æ¶ˆæ¯åæ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();

            // æ¸…ç©ºè¾“å…¥æ¡†
            messageInput.value = '';
            autoResize(messageInput);

            // ç¦ç”¨å‘é€æŒ‰é’®
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="loading"></div>';

            // è·å–é€‰æ‹©çš„æ¨¡å‹
            const modelSelect = document.getElementById('modelSelect');
            const selectedModel = modelSelect.value;

            // æ„å»ºèŠå¤©å®ä½“ - ä½¿ç”¨ç”¨æˆ·idè€Œä¸æ˜¯ç”¨æˆ·å
            const chatEntity = {
                currentUserName: currentUser.id || currentUser.username, // ä½¿ç”¨ç”¨æˆ·id
                message: message,
                botMsgId: botMsgId,
                modelName: selectedModel
            };

            // æ ¹æ®é€‰æ‹©çš„æœç´¢æ¨¡å¼è°ƒç”¨ä¸åŒçš„æ¥å£
            let apiCall;
            let apiEndpoint;
            if (searchModes.knowledge && !searchModes.internet) {
                console.log("è°ƒç”¨ ragSearch æ¥å£");
                apiEndpoint = `${API_BASE_URL}/rag/search`;
                apiCall = axios.post(apiEndpoint, chatEntity, {
                    headers: {
                        'Authorization': `Bearer ${Cookies.get('userToken')}`,
                        'Content-Type': 'application/json'
                    }
                });
            } else if (!searchModes.knowledge && searchModes.internet) {
                console.log("è°ƒç”¨ internetSearch æ¥å£");
                apiEndpoint = `${API_BASE_URL}/internet/search`;
                apiCall = axios.post(apiEndpoint, chatEntity, {
                    headers: {
                        'Authorization': `Bearer ${Cookies.get('userToken')}`,
                        'Content-Type': 'application/json'
                    }
                });
            } else {
                console.log("è°ƒç”¨ doChat æ¥å£");
                apiEndpoint = `${API_BASE_URL}/chat/doChat`;
                apiCall = axios.post(apiEndpoint, chatEntity, {
                    headers: {
                        'Authorization': `Bearer ${Cookies.get('userToken')}`,
                        'Content-Type': 'application/json'
                    }
                });
            }

            console.log('å‘é€APIè¯·æ±‚åˆ°:', apiEndpoint);
            console.log('è¯·æ±‚æ•°æ®:', chatEntity);

            apiCall.then(response => {
                console.log('æ¶ˆæ¯å‘é€æˆåŠŸ:', response.data);
                isSending = false; // é‡ç½®å‘é€çŠ¶æ€
            })
            .catch(error => {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                isSending = false; // é‡ç½®å‘é€çŠ¶æ€

                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                const errorMessage = {
                    id: Date.now(),
                    content: 'æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚',
                    chatType: 'bot',
                    time: new Date()
                };
                chatList.push(errorMessage);
                updateMessageDisplay();
            })
            .finally(() => {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> å‘é€';
                // ç¡®ä¿åœ¨finallyä¸­ä¹Ÿé‡ç½®çŠ¶æ€
                isSending = false;
            });
        }

        // å¤„ç†é”®ç›˜äº‹ä»¶
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(event);
            }
        }

        // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // åˆå§‹åŒ–æ§åˆ¶é¢æ¿
        function initControlPanel() {
            const panelControls = document.getElementById('panelControls');
            const panelToggle = document.getElementById('panelToggle');

            if (isPanelCollapsed) {
                panelControls.classList.add('collapsed');
                panelToggle.classList.add('collapsed');
            } else {
                panelControls.classList.remove('collapsed');
                panelToggle.classList.remove('collapsed');
            }
        }

        // åˆ‡æ¢æ§åˆ¶é¢æ¿
        function toggleControlPanel() {
            isPanelCollapsed = !isPanelCollapsed;
            initControlPanel();
        }

        // è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†åŠŸèƒ½
        let isDropdownOpen = false;

        function toggleDropdown() {
            const dropdown = document.getElementById('modelDropdown');
            const options = document.getElementById('dropdownOptions');
            const trigger = dropdown.querySelector('.dropdown-trigger');
            const arrow = dropdown.querySelector('.dropdown-arrow');

            isDropdownOpen = !isDropdownOpen;

            if (isDropdownOpen) {
                // è®¡ç®—è§¦å‘å™¨åœ¨é¡µé¢ä¸­çš„ç»å¯¹ä½ç½®
                const triggerRect = trigger.getBoundingClientRect();
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

                // è®¾ç½®ä¸‹æ‹‰æ¡†çš„ä½ç½®
                options.style.top = (triggerRect.bottom + scrollTop) + 'px';
                options.style.left = (triggerRect.left + scrollLeft) + 'px';
                options.style.width = triggerRect.width + 'px';

                options.classList.add('show');
                trigger.classList.add('active');
                arrow.classList.add('rotated');
            } else {
                options.classList.remove('show');
                trigger.classList.remove('active');
                arrow.classList.remove('rotated');
            }
        }

        function selectOption(value, text) {
            // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
            document.getElementById('selectedModel').textContent = text;

            // æ›´æ–°åŸç”Ÿselectçš„å€¼
            document.getElementById('modelSelect').value = value;

            // æ›´æ–°é€‰é¡¹é€‰ä¸­çŠ¶æ€
            const options = document.querySelectorAll('.dropdown-option');
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.value === value) {
                    option.classList.add('selected');
                }
            });

            // å…³é—­ä¸‹æ‹‰æ¡†
            toggleDropdown();
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰æ¡†
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('modelDropdown');
            if (!dropdown.contains(event.target) && isDropdownOpen) {
                toggleDropdown();
            }
        });

        // åˆ‡æ¢æœç´¢æ¨¡å¼ï¼ˆäº’æ–¥é€‰æ‹©ï¼‰
        function toggleSearch(type) {
            if (type === 'internet') {
                // å¦‚æœç‚¹å‡»è”ç½‘æœç´¢ï¼Œå…³é—­çŸ¥è¯†åº“æœç´¢
                searchModes.internet = !searchModes.internet;
                searchModes.knowledge = false;
                document.getElementById('internetSearchBtn').classList.toggle('active', searchModes.internet);
                document.getElementById('knowledgeSearchBtn').classList.remove('active');
            } else if (type === 'knowledge') {
                // å¦‚æœç‚¹å‡»çŸ¥è¯†åº“æœç´¢ï¼Œå…³é—­è”ç½‘æœç´¢
                searchModes.knowledge = !searchModes.knowledge;
                searchModes.internet = false;
                document.getElementById('knowledgeSearchBtn').classList.toggle('active', searchModes.knowledge);
                document.getElementById('internetSearchBtn').classList.remove('active');
            }
        }



        // åˆ‡æ¢ç”¨æˆ·èœå•
        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            userMenu.classList.toggle('open');
        }

        // é€€å‡ºç™»å½•
        function logout() {
            Cookies.remove('userToken');
            Cookies.remove('userInfo');
            window.location.href = 'login.html';
        }

        // è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload({ target: { files: files } });
                }
            });
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const files = event.target.files || event.dataTransfer.files;
            if (files.length === 0) return;

            const file = files[0];
            console.log('å¼€å§‹ä¸Šä¼ æ–‡ä»¶:', file.name, 'å¤§å°:', (file.size / 1024 / 1024).toFixed(2), 'MB');

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const allowedTypes = ['text/plain', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            if (!allowedTypes.includes(file.type)) {
                alert('åªæ”¯æŒä¸Šä¼ txtã€pdfã€docã€docxæ ¼å¼çš„æ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å° (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
            const uploadArea = document.getElementById('uploadArea');
            const originalText = uploadArea.innerHTML;
            uploadArea.innerHTML = '<div style="text-align: center; color: #007bff;"><i class="fas fa-spinner fa-spin"></i> ä¸Šä¼ ä¸­...</div>';

            // å‘é€ä¸Šä¼ è¯·æ±‚
            axios.post(`${API_BASE_URL}/rag/uploadRagDoc`, formData, {
                headers: {
                    'Authorization': `Bearer ${Cookies.get('userToken')}`,
                    'Content-Type': 'multipart/form-data'
                }
            })
            .then(response => {
                console.log('ä¸Šä¼ æˆåŠŸ:', response);
                if (response.status === 200) {
                    alert('âœ… ä¸Šä¼ çŸ¥è¯†åº“æ–‡æ¡£æˆåŠŸï¼');
                    // é‡ç½®æ–‡ä»¶è¾“å…¥æ¡†
                    const fileInput = document.getElementById('fileInput');
                    if (fileInput) fileInput.value = '';
                } else {
                    alert('âŒ ä¸Šä¼ å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›é”™è¯¯');
                }
            })
            .catch(error => {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('âŒ ä¸Šä¼ å¤±è´¥ï¼š' + (error.response?.data?.message || error.message));
            })
            .finally(() => {
                // æ¢å¤åŸå§‹çŠ¶æ€
                uploadArea.innerHTML = originalText;
            });
        }

        // è®¾ç½®èœå•
        function setupMenus() {
            // ç‚¹å‡»å¤–éƒ¨å…³é—­ç”¨æˆ·èœå•
            document.addEventListener('click', (e) => {
                const userMenu = document.getElementById('userMenu');
                const userAvatar = document.getElementById('userAvatar');

                if (userMenu && !userMenu.contains(e.target) && !userAvatar.contains(e.target)) {
                    userMenu.classList.remove('open');
                }
            });
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            return date.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆä¸bakç‰ˆæœ¬ä¸€è‡´ï¼‰
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }


    </script>
</body>
</html>

